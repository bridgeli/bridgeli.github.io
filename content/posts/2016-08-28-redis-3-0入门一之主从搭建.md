---
title: Redis 3.0入门一之主从搭建
author: Bridge Li
type: post
date: 2016-08-28T21:40:02+00:00

categories:
  - Redis
tags:
  - HA
  - redis
  - 集群

---
周末没事看北京尚学堂之前的公开课视频，发现了白贺翔老师有一节课讲redis 3.0的视频教程，还不错，以下是学习笔记。

一、单机版搭建

首先是下载地址：http://redis.io/download，假设我们下载是redis-3.0.0-rc2.tar.gz  
安装步骤：

1. 把我们下载好的redis-3.0.0-rc2.tar.gz放到Linux的/usr/local文件夹下  
2. 解压tar -xzvf redis-3.0.0-rc2.tar.gz -C /usr/local/  
3. 进入到redis-3.0.0-rc2目录下，进项make  
4. 进入到src下进行安装make install，验证（ll查看发现src下的目录，有redis-server、redis-cli即可）  
5. 建立两个文件夹存放redis命令和配置文件

```

mkdir -p /usr/local/redis/etc  
mkdir -p /usr/local/redis/bin

```

6. 把redis-3.0.0-rc2下的redis.conf移动到/usr/local/redis/etc下

```

mv redis.conf /usr/local/redis/etc

```

7. 把redis-3.0.0-rc2/src里的mkreleasehdr.sh、redis-benchmark、redis-check-aof、redis-check-dump、redis-cli、redis-server文件移动到bin下，命令

```

mv mkreleasehdr.sh redis-benchmark redis-check-aof redis-check-dump redis-cli redis-server /usr/local/redis/bin

```

8. 启动并指定配置文件

```

/usr/local/redis/bin/redis-server /usr/local/redis/etc/redis.conf

```

9. 退出改为后台启动

退出就不说了，改为后台启动，编辑 /usr/local/redis/etc/redis.conf找到

```

daemonize no

```

改为

```

daemonize yes

```

10. 修改持久化文件存放的位置，修改

```

dir ./

```

为

```

dir /usr/local/redis/data/

```

11. redis客户端的使用

```

/usr/local/redis/binredis-cli -h host -p port

```

12. 设置密码

通过刚才的操作应该可以发现redis默认是没有密码的，这样很不安全，设置密码的方法是编辑/usr/local/redis/etc/redis.conf找到requirepass 这一行，设置

```

requirepass bridgeli

```

这样通过客户端进入的时候加一个参数 -a 跟上你的密码就好了

二、 主从搭建

当然是首先搭建两台单机版，然后如果想要某一台成为slave，就编辑这一台机器的配置文集，找到

```

#slaveof <masterip> <masterport>

```

这一行（对，默认是被注释掉的，这不废话吗），然后按照这个模式，写上master的信息就好了，之后重启主从机器，就可以通过命令：info来查看主从角色

三、redis服务器监控（哨兵）

实现步骤（在任一台服务器上配置sentinel.conf）：

1. copysentinel.conf到/usr/local/redis/ect下  
2. 修改sentinel.conf文件

```

sentinel monitor mymaster 127.0.0.1 6379 1 #名称 ip 端口 投票选举次数  
sentinel down-after-millisenconds mymaster 5000 #默认1S检测一次，这里配置超市5000ms为宕机  
sentinel failover-timeout mymaster 900000  
sentinel can-failover mymaster yes  
sentinel parallel-syncs mymaster 2

```

3. 启动sentinel哨兵

```

/usr/local/redis/bin/redis-server /usr/local/redis/ect/sentinel.conf &#8211;sentinel &

```

4. 查看哨兵相关信息

```

/usr.local.redis/bin/redis-cli -h 127.0.0.1 -p 26379 info sentinel

```

四、redis的持久化

默认是snapshotting不做介绍，多用户demo，实际中多用append-only file（缩写aof）

编辑配置文件把

```

appendonly no

```

改成

```

appendonly yes

```

还有相关持久化方案

```

#appendfsync always // 收到写命令就立即写入磁盘，效率最慢，但是能保证完全的持久化  
#appendfsync everysec // 每秒钟写入磁盘一次，在性能和持久化方面做了很好的折中  
#appendfsync no // 完全依赖OS性能最好，持久化没保证

```