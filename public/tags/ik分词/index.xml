<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>IKåˆ†è¯ on åˆ†äº«æŠ€æœ¯å¸¦æ¥çš„å–œæ‚¦</title>
    <link>http://localhost:1313/tags/ik%E5%88%86%E8%AF%8D/</link>
    <description>Recent content in IKåˆ†è¯ on åˆ†äº«æŠ€æœ¯å¸¦æ¥çš„å–œæ‚¦</description>
    <generator>Hugo -- 0.156.0</generator>
    <language>zh-cn</language>
    <lastBuildDate>Thu, 28 Aug 2025 09:26:14 +0000</lastBuildDate>
    <atom:link href="http://localhost:1313/tags/ik%E5%88%86%E8%AF%8D/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>ä½¿ç”¨ docker ä¸€é”®éƒ¨ç½² ELK(åŒ…å«ä¸­æ–‡åˆ†è¯) æœåŠ¡è„šæœ¬</title>
      <link>http://localhost:1313/posts/2025-08-28-%E4%BD%BF%E7%94%A8-docker-%E4%B8%80%E9%94%AE%E9%83%A8%E7%BD%B2-elk-%E6%9C%8D%E5%8A%A1%E8%84%9A%E6%9C%AC/</link>
      <pubDate>Thu, 28 Aug 2025 09:26:14 +0000</pubDate>
      <guid>http://localhost:1313/posts/2025-08-28-%E4%BD%BF%E7%94%A8-docker-%E4%B8%80%E9%94%AE%E9%83%A8%E7%BD%B2-elk-%E6%9C%8D%E5%8A%A1%E8%84%9A%E6%9C%AC/</guid>
      <description>&lt;p&gt;å‰å‡ å¤©å…¬å¸æœ‰ä¸ªéœ€æ±‚è¦åšå…¨æ–‡ç´¢å¼•ï¼Œäºæ˜¯å†™äº†ä¸€ä¸ªè„šæœ¬ä½¿ç”¨ docker ä¸€é”®éƒ¨ç½² ELK æœåŠ¡ï¼Œå†…å®¹å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;
#!/bin/bash  
set -e

echo &amp;#34;==================================================&amp;#34;  
echo &amp;#34;ğŸš€ å¼€å§‹éƒ¨ç½² ELK + MySQL åŒæ­¥ï¼ˆä¸­æ–‡åˆ†è¯ + å›ºå®šç´¢å¼•ï¼‰&amp;#34;  
echo &amp;#34;==================================================&amp;#34;

\# ==================== é…ç½®åŒºï¼ˆè¯·ä¿®æ”¹ï¼‰====================  
MYSQL_HOST=&amp;#34;192.168.124.6&amp;#34; # âœï¸ ä¿®æ”¹ä¸ºä½ çš„ MySQL IP  
MYSQL_USER=&amp;#34;root&amp;#34; # è¯»å–æƒé™ç”¨æˆ·  
MYSQL_PASSWORD=&amp;#34;123456&amp;#34; # ç”¨æˆ·å¯†ç   
MYSQL_DB=&amp;#34;ams&amp;#34; # æ•°æ®åº“å

ELASTIC_PASSWORD=&amp;#34;i*B4j6eD+g0e&amp;#34; # ES å¯†ç ï¼ˆè‡³å°‘ 8 ä½ï¼Œå«å¤§å°å†™+æ•°å­—ï¼‰

ES_VERSION=&amp;#34;8.11.3&amp;#34; # å¿…é¡»ä¸ IK æ’ä»¶ç‰ˆæœ¬ä¸€è‡´  
LOGSTASH_VERSION=&amp;#34;8.11.3&amp;#34;  
\# ========================================================

\# é¡¹ç›®è·¯å¾„  
ROOT_DIR=&amp;#34;/project/elastic-sync&amp;#34;  
mkdir -p &amp;#34;$ROOT_DIR&amp;#34;  
cd &amp;#34;$ROOT_DIR&amp;#34;

echo &amp;#34;ğŸ“ åˆ›å»ºé¡¹ç›®ç›®å½•ç»“æ„&amp;#34;  
mkdir -p config/mysql config data/es data/kibana logs/logstash plugins/ik

\# &amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;- ä¸‹è½½ IK åˆ†è¯æ’ä»¶ &amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;  
IK_URL=&amp;#34;https://release.infinilabs.com/analysis-ik/stable/elasticsearch-analysis-ik-ik-${ES_VERSION}.zip&amp;#34;  
IK_DIR=&amp;#34;$ROOT_DIR/plugins/ik&amp;#34;

if [ ! -f &amp;#34;$IK_DIR/plugin-descriptor.properties&amp;#34; ]; then  
echo &amp;#34;ğŸ“¥ æ­£åœ¨ä¸‹è½½ IK åˆ†è¯æ’ä»¶ v${ES_VERSION}&amp;amp;#8230;&amp;#34;  
wget -q &amp;#34;$IK_URL&amp;#34; -O /tmp/ik.zip  
unzip -q /tmp/ik.zip -d &amp;#34;$IK_DIR&amp;#34;  
rm /tmp/ik.zip  
chown -R 1000:1000 &amp;#34;$IK_DIR&amp;#34;  
echo &amp;#34;âœ… IK æ’ä»¶å®‰è£…å®Œæˆ&amp;#34;  
else  
echo &amp;#34;â„¹ï¸ IK æ’ä»¶å·²å­˜åœ¨ï¼Œè·³è¿‡å®‰è£…&amp;#34;  
fi

\# &amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;- ç”Ÿæˆ elasticsearch.yml &amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;-  
cat &amp;gt; config/elasticsearch.yml &amp;lt;&amp;lt; EOF  
cluster.name: production-cluster  
node.name: node-1  
node.roles: [ data, master, ingest ]

path:  
data: /usr/share/elasticsearch/data  
logs: /usr/share/elasticsearch/logs

network.host: 0.0.0.0  
http.port: 9200

http.cors.enabled: true  
http.cors.allow-origin: &amp;#34;*&amp;#34;

discovery.type: single-node

xpack.security.enabled: true  
xpack.security.http.ssl.enabled: false

xpack.monitoring.collection.enabled: true  
EOF

\# &amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;- ç”Ÿæˆ logstash.yml &amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;-  
cat &amp;gt; config/logstash.yml &amp;lt;&amp;lt; EOF  
http.host: &amp;#34;0.0.0.0&amp;#34;  
xpack.monitoring.enabled: false  
config.reload.automatic: false  
EOF

\# &amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;- ç”Ÿæˆ logstash.conf &amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;-  
cat &amp;gt; config/logstash.conf &amp;lt;&amp;lt; EOF  
input {  
jdbc {  
jdbc_connection_string =&amp;gt; &amp;#34;jdbc:mysql://$MYSQL_HOST:3306/$MYSQL_DB?useUnicode=true&amp;amp;characterEncoding=UTF-8&amp;amp;useSSL=false&amp;amp;serverTimezone=Asia/Shanghai&amp;#34;  
jdbc_user =&amp;gt; &amp;#34;$MYSQL_USER&amp;#34;  
jdbc_password =&amp;gt; &amp;#34;$MYSQL_PASSWORD&amp;#34;  
jdbc_driver_library =&amp;gt; &amp;#34;/usr/share/logstash/mysql/mysql-connector-java-8.0.30.jar&amp;#34;  
jdbc_driver_class =&amp;gt; &amp;#34;com.mysql.cj.jdbc.Driver&amp;#34;

jdbc_default_timezone =&amp;gt; &amp;#34;Asia/Shanghai&amp;#34;

statement =&amp;gt; &amp;#34;  
SELECT * FROM article  
WHERE updated_at &amp;gt;= :sql_last_value  
ORDER BY updated_at ASC  
&amp;#34;

use_column_value =&amp;gt; true  
tracking_column =&amp;gt; &amp;#34;updated_at&amp;#34;  
tracking_column_type =&amp;gt; &amp;#34;timestamp&amp;#34;  
last_run_metadata_path =&amp;gt; &amp;#34;/usr/share/logstash/.logstash_jdbc_last_run&amp;#34;

schedule =&amp;gt; &amp;#34;\*/2 \* \* \* *&amp;#34;  
}  
}

filter {

\# æ¸…æ´— content å­—æ®µä¸­çš„ HTML æ ‡ç­¾  
if [content] {  
mutate {  
gsub =&amp;gt; [  
&amp;#34;content&amp;#34;, &amp;#34;&amp;lt;[^&amp;gt;]*&amp;gt;&amp;#34;, &amp;#34;&amp;#34; # åˆ é™¤æ‰€æœ‰ HTML æ ‡ç­¾ï¼š&amp;lt;p&amp;gt;ã€&amp;lt;div&amp;gt;ã€&amp;lt;span&amp;gt; ç­‰  
]  
}  
\# å¯é€‰ï¼šè¿›ä¸€æ­¥æ¸…ç†å¤šä½™çš„ç©ºç™½å­—ç¬¦  
mutate {  
gsub =&amp;gt; [  
&amp;#34;content&amp;#34;, &amp;#34;\s+&amp;#34;, &amp;#34; &amp;#34; # å¤šä¸ªç©ºç™½å­—ç¬¦ï¼ˆç©ºæ ¼ã€æ¢è¡Œã€åˆ¶è¡¨ç¬¦ï¼‰åˆå¹¶ä¸ºä¸€ä¸ªç©ºæ ¼  
]  
}  
mutate {  
strip =&amp;gt; [&amp;#34;content&amp;#34;] # å»é™¤é¦–å°¾ç©ºæ ¼  
}  
}

\# å¦‚æœ del_flag æ˜¯ 1ï¼Œæ ‡è®°è¯¥è®°å½•ç”¨äºåˆ é™¤  
if [del_flag] == 1 {  
mutate {  
add_tag =&amp;gt; [&amp;#34;delete_document&amp;#34;]  
}  
}  
}

output {  
if &amp;#34;delete_document&amp;#34; in [tags] {  
elasticsearch {  
hosts =&amp;gt; [&amp;#34;http://elasticsearch:9200&amp;#34;]  
user =&amp;gt; &amp;#34;elastic&amp;#34;  
password =&amp;gt; &amp;#34;$ELASTIC_PASSWOR&amp;#34;  
action =&amp;gt; &amp;#34;delete&amp;#34;  
document_id =&amp;gt; &amp;#34;%{id}&amp;#34;  
index =&amp;gt; &amp;#34;articles&amp;#34;  
}  
} else {  
elasticsearch {  
hosts =&amp;gt; [&amp;#34;http://elasticsearch:9200&amp;#34;]  
user =&amp;gt; &amp;#34;elastic&amp;#34;  
password =&amp;gt; &amp;#34;$ELASTIC_PASSWOR&amp;#34;  
index =&amp;gt; &amp;#34;articles&amp;#34; # âœ… å›ºå®šç´¢å¼•  
document_id =&amp;gt; &amp;#34;%{id}&amp;#34; # æ”¯æŒ varchar id  
doc_as_upsert =&amp;gt; true # æ›´æ–°è¦†ç›–  
}  
}

stdout { codec =&amp;gt; rubydebug }  
}  
EOF

\# &amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;- ç”Ÿæˆ docker-compose.yml &amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;-  
cat &amp;gt; docker-compose.yml &amp;lt;&amp;lt; EOF  
services:  
elasticsearch:  
image: docker.elastic.co/elasticsearch/elasticsearch:$ES_VERSION  
container_name: elasticsearch  
environment:  
&amp;amp;#8211; discovery.type=single-node  
&amp;amp;#8211; ES_JAVA_OPTS=-Xms2g -Xmx2g  
&amp;amp;#8211; xpack.security.enabled=true  
&amp;amp;#8211; xpack.security.http.ssl.enabled=false  
&amp;amp;#8211; ELASTIC_PASSWORD=$ELASTIC_PASSWORD  
ports:  
&amp;amp;#8211; &amp;#34;9200:9200&amp;#34;  
volumes:  
&amp;amp;#8211; ./data/es:/usr/share/elasticsearch/data  
&amp;amp;#8211; ./config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml  
&amp;amp;#8211; ./plugins/ik:/usr/share/elasticsearch/plugins/ik  
networks:  
&amp;amp;#8211; elastic  
restart: unless-stopped  
healthcheck:  
test: [&amp;#34;CMD-SHELL&amp;#34;, &amp;#34;curl -f http://localhost:9200 || exit 1&amp;#34;]  
interval: 30s  
timeout: 10s  
retries: 3

kibana:  
image: docker.elastic.co/kibana/kibana:$LOGSTASH_VERSION  
container_name: kibana  
depends_on:  
elasticsearch:  
condition: service_healthy  
environment:  
&amp;amp;#8211; ELASTICSEARCH_HOSTS=[&amp;#34;http://elasticsearch:9200&amp;#34;]  
&amp;amp;#8211; ELASTICSEARCH_USERNAME=elastic  
&amp;amp;#8211; ELASTICSEARCH_PASSWORD=$ELASTIC_PASSWORD  
&amp;amp;#8211; SERVER_NAME=kibana.example.com  
&amp;amp;#8211; I18N_LOCALE=zh-CN  
ports:  
&amp;amp;#8211; &amp;#34;5601:5601&amp;#34;  
volumes:  
&amp;amp;#8211; ./data/kibana:/usr/share/kibana/data  
networks:  
&amp;amp;#8211; elastic  
restart: unless-stopped

logstash:  
image: docker.elastic.co/logstash/logstash:$LOGSTASH_VERSION  
container_name: logstash  
depends_on:  
&amp;amp;#8211; elasticsearch  
volumes:  
&amp;amp;#8211; ./config/logstash.conf:/usr/share/logstash/pipeline/logstash.conf  
&amp;amp;#8211; ./config/logstash.yml:/usr/share/logstash/config/logstash.yml  
&amp;amp;#8211; ./logs/logstash:/var/log/logstash  
&amp;amp;#8211; ./config/mysql:/usr/share/logstash/mysql  
networks:  
&amp;amp;#8211; elastic  
restart: unless-stopped

networks:  
elastic:  
driver: bridge  
EOF

\# &amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;- ä¸‹è½½ MySQL JDBC é©±åŠ¨ &amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;-  
JDBC_JAR=&amp;#34;config/mysql/mysql-connector-java-8.0.30.jar&amp;#34;  
if [ ! -f &amp;#34;$JDBC_JAR&amp;#34; ]; then  
echo &amp;#34;ğŸ“¥ ä¸‹è½½ MySQL JDBC é©±åŠ¨&amp;amp;#8230;&amp;#34;  
mkdir -p config/mysql  
wget -q https://repo1.maven.org/maven2/mysql/mysql-connector-java/8.0.30/mysql-connector-java-8.0.30.jar -O &amp;#34;$JDBC_JAR&amp;#34;  
echo &amp;#34;âœ… JDBC é©±åŠ¨ä¸‹è½½å®Œæˆ&amp;#34;  
fi

\# &amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;- è®¾ç½®æƒé™ &amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;-  
echo &amp;#34;ğŸ” è®¾ç½®ç›®å½•æƒé™&amp;#34;  
chown -R 1000:1000 data/es plugins/ik  
chmod -R 755 config logs  
chmod -R 777 data/kibana

\# &amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;- ç”Ÿæˆåˆ›å»ºç´¢å¼•è„šæœ¬ &amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;-  
cat &amp;gt; create-index.sh &amp;lt;&amp;lt; &amp;amp;#8216;EOF&amp;amp;#8217;  
#!/bin/bash  
echo &amp;#34;ğŸ”„ æ­£åœ¨åˆ›å»ºç´¢å¼• &amp;amp;#8216;articles&amp;amp;#8217; å¹¶é…ç½® IK åˆ†è¯å™¨&amp;amp;#8230;&amp;#34;

curl -X PUT &amp;#34;http://localhost:9200/articles&amp;#34; \  
-u elastic:$ELASTIC_PASSWORD \  
-H &amp;#34;Content-Type: application/json&amp;#34; \  
-d &amp;amp;#8216;  
{  
&amp;#34;settings&amp;#34;: {  
&amp;#34;index&amp;#34;: {  
&amp;#34;number_of_shards&amp;#34;: 1,  
&amp;#34;number_of_replicas&amp;#34;: 1  
},  
&amp;#34;analysis&amp;#34;: {  
&amp;#34;analyzer&amp;#34;: {  
&amp;#34;ik_analyzer&amp;#34;: {  
&amp;#34;type&amp;#34;: &amp;#34;custom&amp;#34;,  
&amp;#34;tokenizer&amp;#34;: &amp;#34;ik_max_word&amp;#34;,  
&amp;#34;filter&amp;#34;: [&amp;#34;lowercase&amp;#34;]  
}  
}  
}  
},  
&amp;#34;mappings&amp;#34;: {  
&amp;#34;properties&amp;#34;: {  
&amp;#34;id&amp;#34;: { &amp;#34;type&amp;#34;: &amp;#34;keyword&amp;#34; },  
&amp;#34;title&amp;#34;: {  
&amp;#34;type&amp;#34;: &amp;#34;text&amp;#34;,  
&amp;#34;analyzer&amp;#34;: &amp;#34;ik_max_word&amp;#34;,  
&amp;#34;search_analyzer&amp;#34;: &amp;#34;ik_smart&amp;#34;  
},  
&amp;#34;content&amp;#34;: {  
&amp;#34;type&amp;#34;: &amp;#34;text&amp;#34;,  
&amp;#34;analyzer&amp;#34;: &amp;#34;ik_max_word&amp;#34;,  
&amp;#34;search_analyzer&amp;#34;: &amp;#34;ik_smart&amp;#34;  
},  
&amp;#34;author&amp;#34;: { &amp;#34;type&amp;#34;: &amp;#34;keyword&amp;#34; },  
&amp;#34;created_at&amp;#34;: { &amp;#34;type&amp;#34;: &amp;#34;date&amp;#34; },  
&amp;#34;updated_at&amp;#34;: { &amp;#34;type&amp;#34;: &amp;#34;date&amp;#34; }  
}  
}  
}&amp;amp;#8217; &amp;amp;&amp;amp; echo &amp;#34;âœ… ç´¢å¼• &amp;amp;#8216;articles&amp;amp;#8217; åˆ›å»ºæˆåŠŸï¼&amp;#34;  
EOF

chmod +x create-index.sh

\# &amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;- å®Œæˆ &amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;&amp;amp;#8212;-  
echo &amp;#34;==================================================&amp;#34;  
echo &amp;#34;ğŸ‰ éƒ¨ç½²å‡†å¤‡å®Œæˆï¼&amp;#34;  
echo &amp;#34;==================================================&amp;#34;  
echo &amp;#34;&amp;#34;  
echo &amp;#34;ğŸ“Œ ä¸‹ä¸€æ­¥æ“ä½œï¼š&amp;#34;  
echo &amp;#34;1. æ£€æŸ¥é…ç½®ï¼šnano setup-elastic-sync.sh ï¼ˆä¿®æ”¹ MySQL åœ°å€ã€ç”¨æˆ·ã€å¯†ç ï¼‰&amp;#34;  
echo &amp;#34;2. å¢åŠ æƒé™ï¼šchmod +x setup-elastic-sync.sh&amp;#34;  
echo &amp;#34;3. æ‰§è¡Œè„šæœ¬ï¼šsudo ./setup-elastic-sync.sh&amp;#34;  
echo &amp;#34;4. å¯åŠ¨æœåŠ¡ï¼šsudo docker compose up -d&amp;#34;  
echo &amp;#34;5. åˆ›å»ºç´¢å¼•ï¼šbash ./create-index.sh&amp;#34;  
echo &amp;#34;6. è®¿é—® Kibanaï¼šhttp://ä½ çš„æœåŠ¡å™¨IP:5601&amp;#34;  
echo &amp;#34; &amp;amp;#8211; ç”¨æˆ·ï¼šelastic&amp;#34;  
echo &amp;#34; &amp;amp;#8211; å¯†ç ï¼š$ELASTIC_PASSWORD&amp;#34;  
echo &amp;#34;&amp;#34;  
echo &amp;#34;ğŸ’¡ é¦–æ¬¡è¿è¡Œä¼šå…¨é‡åŒæ­¥ articles è¡¨ï¼Œä¹‹åæ¯ 2 åˆ†é’Ÿå¢é‡åŒæ­¥&amp;#34;  
echo &amp;#34;ğŸ” åœ¨ Kibana ä¸­æœç´¢ä¸­æ–‡ï¼ˆå¦‚â€œé˜¿é‡Œå·´å·´â€ï¼‰ï¼Œåº”èƒ½å‘½ä¸­ç»“æœ&amp;#34;  
echo &amp;#34;&amp;#34;  
echo &amp;#34;âš ï¸ æ³¨æ„ï¼šå¿…é¡»å…ˆè¿è¡Œ create-index.sh å†è®© Logstash å†™å…¥ï¼Œå¦åˆ™åˆ†è¯æ— æ•ˆï¼&amp;#34;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;å¦‚æœ kibana ç”¨ elastic ç”¨æˆ·è¿ä¸ä¸Šï¼Œé€šè¿‡ Elasticsearch çš„ Security API ä¸ºå†…ç½®ç”¨æˆ· kibana_system ä¿®æ”¹å¯†ç ï¼š&lt;/p&gt;</description>
    </item>
  </channel>
</rss>
