<!DOCTYPE html>
<html lang="en" dir="auto" data-theme="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>【转载】设计 RPC 接口时，你有考虑过这些吗？ | 分享技术带来的喜悦</title>
<meta name="keywords" content="rpc, 接口">
<meta name="description" content="按：系统架构经过多年演进，现在越来越多的系统采用微服务架构，而微服务架构最重要的就是面向接口编程，所以接口的设计就尤为重要了，我一直认为一个好的接口自己会说话，也就是看到接口，我就知道这个接口是干啥的、参数是啥、返回值是啥以及可能会遇到哪些问题，但目前对 RPC 接口设计可以说有两派，前一段时间看了一篇文章是我的想法完全一样，特转载到本人博客，希望更多的能够看到、有更多的人参与讨论两种的优劣。
在开始之前呢，先吐槽一个本文没有提到的问题，我不知道有些人是怎么想的，对外暴露的接口，也就是最终被打成 jar 包供外部服务依赖模块，有些人喜欢在里面引入各种无关的第三方依赖，我遇到过把 spring mvc、spring、mybatis、dubbo 等等还有其他的像 POI 什么乱七八糟的第三方 jar 都依赖进来的，说实话，我只想问：可以说脏话吗？不可以啊，那好吧，我无话可说了，我们开始看原文吧。
RPC 框架的讨论一直是各个技术交流群中的热点话题，阿里的 dubbo，新浪微博的 motan，谷歌的 grpc，以及不久前蚂蚁金服开源的 sofa，都是比较出名的 RPC 框架。RPC 框架，或者一部分人习惯称之为服务治理框架，更多的讨论是存在于其技术架构，比如 RPC 的实现原理，RPC 各个分层的意义，具体 RPC 框架的源码分析…但却并没有太多话题和“如何设计 RPC 接口”这样的业务架构相关。
 
可能很多小公司程序员还是比较关心这个问题的，这篇文章主要分享下一些个人眼中 RPC 接口设计的最佳实践。

初识 RPC 接口设计

由于 RPC 中的术语每个程序员的理解可能不同，所以文章开始，先统一下 RPC 术语，方便后续阐述。
大家都知道共享接口是 RPC 最典型的一个特点，每个服务对外暴露自己的接口，该模块一般称之为 api；外部模块想要实现对该模块的远程调用，则需要依赖其 api；每个服务都需要有一个应用来负责实现自己的 api，一般体现为一个独立的进程，该模块一般称之为 app。
api 和 app 是构建微服务项目的最简单组成部分，如果使用 maven 的多 module 组织代码，则体现为如下的形式。
serviceA 服务
serviceA/pom.xml 定义父 pom 文件

&lt;modules&gt;  
&lt;module&gt;serviceA-api&lt;/module&gt;  
&lt;module&gt;serviceA-app&lt;/module&gt;  
&lt;/modules&gt;

&lt;packaging&gt;pom&lt;/packaging&gt;  
&lt;groupId&gt;moe.cnkirito&lt;/groupId&gt;  
&lt;artifactId&gt;serviceA&lt;/artifactId&gt;  
&lt;version&gt;1.0.0-SNAPSHOT&lt;/version&gt;
serviceA/serviceA-api/pom.xml 定义对外暴露的接口，最终会被打成 jar 包供外部服务依赖">
<meta name="author" content="Bridge Li">
<link rel="canonical" href="http://localhost:1313/posts/2018-09-02-%E8%BD%AC%E8%BD%BD%E8%AE%BE%E8%AE%A1-rpc-%E6%8E%A5%E5%8F%A3%E6%97%B6%E4%BD%A0%E6%9C%89%E8%80%83%E8%99%91%E8%BF%87%E8%BF%99%E4%BA%9B%E5%90%97/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.a29c24210eb31d9ce56f669c66a35c9c51b17376b7764e336a49af7dec914cf0.css" integrity="sha256-opwkIQ6zHZzlb2acZqNcnFGxc3a3dk4zakmvfeyRTPA=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/2018-09-02-%E8%BD%AC%E8%BD%BD%E8%AE%BE%E8%AE%A1-rpc-%E6%8E%A5%E5%8F%A3%E6%97%B6%E4%BD%A0%E6%9C%89%E8%80%83%E8%99%91%E8%BF%87%E8%BF%99%E4%BA%9B%E5%90%97/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
                color-scheme: dark;
            }

            .list {
                background: var(--theme);
            }

            .toc {
                background: var(--entry);
            }
        }

        @media (prefers-color-scheme: light) {
            .list::-webkit-scrollbar-thumb {
                border-color: var(--code-bg);
            }
        }

    </style>
</noscript>
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.querySelector("html").dataset.theme = 'dark';
    } else if (localStorage.getItem("pref-theme") === "light") {
       document.querySelector("html").dataset.theme = 'light';
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.querySelector("html").dataset.theme = 'dark';
    } else {
        document.querySelector("html").dataset.theme = 'light';
    }

</script>
</head>
<body id="top">
    <header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="分享技术带来的喜悦 (Alt + H)">分享技术带来的喜悦</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/posts/" title="文章">
                    <span>文章</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/about/" title="关于">
                    <span>关于</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/archives/" title="归档">
                    <span>归档</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/posts/">文章</a></div>
    <h1 class="post-title entry-hint-parent">
      【转载】设计 RPC 接口时，你有考虑过这些吗？
    </h1>
    <div class="post-meta"><span title='2018-09-02 08:05:17 +0000 +0000'>September 2, 2018</span>&nbsp;·&nbsp;<span>3 min</span>&nbsp;·&nbsp;<span>635 words</span>&nbsp;·&nbsp;<span>Bridge Li</span>

</div>
  </header> 
  <div class="post-content"><p>按：系统架构经过多年演进，现在越来越多的系统采用微服务架构，而微服务架构最重要的就是面向接口编程，所以接口的设计就尤为重要了，我一直认为一个好的接口自己会说话，也就是看到接口，我就知道这个接口是干啥的、参数是啥、返回值是啥以及可能会遇到哪些问题，但目前对 RPC 接口设计可以说有两派，前一段时间看了一篇文章是我的想法完全一样，特转载到本人博客，希望更多的能够看到、有更多的人参与讨论两种的优劣。</p>
<p>在开始之前呢，先吐槽一个本文没有提到的问题，我不知道有些人是怎么想的，对外暴露的接口，也就是最终被打成 jar 包供外部服务依赖模块，有些人喜欢在里面引入各种无关的第三方依赖，我遇到过把 spring mvc、spring、mybatis、dubbo 等等还有其他的像 POI 什么乱七八糟的第三方 jar 都依赖进来的，说实话，我只想问：可以说脏话吗？不可以啊，那好吧，我无话可说了，我们开始看原文吧。</p>
<p>RPC 框架的讨论一直是各个技术交流群中的热点话题，阿里的 dubbo，新浪微博的 motan，谷歌的 grpc，以及不久前蚂蚁金服开源的 sofa，都是比较出名的 RPC 框架。RPC 框架，或者一部分人习惯称之为服务治理框架，更多的讨论是存在于其技术架构，比如 RPC 的实现原理，RPC 各个分层的意义，具体 RPC 框架的源码分析…但却并没有太多话题和“如何设计 RPC 接口”这样的业务架构相关。</p>
<img loading="lazy" decoding="async" src="https://www.bridgeli.cn/wp-content/uploads/2018/09/jokes-1024x482.png" alt="" width="1024" height="482" class="alignnone size-medium wp-image-572" /> 
<p>可能很多小公司程序员还是比较关心这个问题的，这篇文章主要分享下一些个人眼中 RPC 接口设计的最佳实践。</p>
<ol>
<li>初识 RPC 接口设计</li>
</ol>
<p>由于 RPC 中的术语每个程序员的理解可能不同，所以文章开始，先统一下 RPC 术语，方便后续阐述。</p>
<p>大家都知道共享接口是 RPC 最典型的一个特点，每个服务对外暴露自己的接口，该模块一般称之为 api；外部模块想要实现对该模块的远程调用，则需要依赖其 api；每个服务都需要有一个应用来负责实现自己的 api，一般体现为一个独立的进程，该模块一般称之为 app。</p>
<p>api 和 app 是构建微服务项目的最简单组成部分，如果使用 maven 的多 module 组织代码，则体现为如下的形式。</p>
<p>serviceA 服务</p>
<p>serviceA/pom.xml 定义父 pom 文件</p>
<pre tabindex="0"><code>
&lt;modules&gt;  
&lt;module&gt;serviceA-api&lt;/module&gt;  
&lt;module&gt;serviceA-app&lt;/module&gt;  
&lt;/modules&gt;

&lt;packaging&gt;pom&lt;/packaging&gt;  
&lt;groupId&gt;moe.cnkirito&lt;/groupId&gt;  
&lt;artifactId&gt;serviceA&lt;/artifactId&gt;  
&lt;version&gt;1.0.0-SNAPSHOT&lt;/version&gt;
</code></pre><p>serviceA/serviceA-api/pom.xml 定义对外暴露的接口，最终会被打成 jar 包供外部服务依赖</p>
<pre tabindex="0"><code>
&lt;parent&gt;  
&lt;artifactId&gt;serviceA&lt;/artifactId&gt;  
&lt;groupId&gt;moe.cnkirito&lt;/groupId&gt;  
&lt;version&gt;1.0.0-SNAPSHOT&lt;/version&gt;  
&lt;/parent&gt;

&lt;packaging&gt;jar&lt;/packaging&gt;  
&lt;artifactId&gt;serviceA-api&lt;/artifactId&gt;
</code></pre><p>serviceA/serviceA-app/pom.xml 定义了服务的实现，一般是 springboot 应用，所以下面的配置文件中，我配置了 springboot 应用打包的插件，最终会被打成 jar 包，作为独立的进程运行。</p>
<pre tabindex="0"><code>
&lt;parent&gt;  
&lt;artifactId&gt;serviceA&lt;/artifactId&gt;  
&lt;groupId&gt;moe.cnkirito&lt;/groupId&gt;  
&lt;version&gt;1.0.0-SNAPSHOT&lt;/version&gt;  
&lt;/parent&gt;

&lt;packaging&gt;jar&lt;/packaging&gt;  
&lt;artifactId&gt;serviceA-app&lt;/artifactId&gt;

&lt;build&gt;  
&lt;plugins&gt;  
&lt;plugin&gt;  
&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;  
&lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;  
&lt;/plugin&gt;  
&lt;/plugins&gt;  
&lt;/build&gt;
</code></pre><p>麻雀虽小，五脏俱全，这样一个微服务模块就实现了。</p>
<ol start="2">
<li>旧 RPC 接口的痛点</li>
</ol>
<p>统一好术语，这一节来描述下我曾经遭遇过的 RPC 接口设计的痛点，相信不少人有过相同的遭遇。</p>
<p>查询接口过多。各种 findBy 方法，加上各自的重载，几乎占据了一个接口 80% 的代码量。这也符合一般人的开发习惯，因为页面需要各式各样的数据格式，加上查询条件差异很大，便造成了：一个查询条件，一个方法的尴尬场景。这样会导致另外一个问题，需要使用某个查询方法时，直接新增了方法，但实际上可能这个方法已经出现过了，隐藏在了令人眼花缭乱的方法中。</p>
<p>难以扩展。接口的任何改动，比如新增一个入参，都会导致调用者被迫升级，这也通常是 RPC 设计被诟病的一点，不合理的 RPC 接口设计会放大这个缺点。</p>
<p>升级困难。 在之前的 “初识 RPC 接口设计”一节中，版本管理的粒度是 project，而不是 module，这意味着：api 即使没有发生变化，app 版本演进，也会造成 api 的被迫升级，因为 project 是一个整体。问题又和上一条一样了，api 一旦发生变化，调用者也得被迫升级，牵一发而动全身。</p>
<p>难以测试。接口一多，职责随之变得繁杂，业务场景各异，测试用例难以维护。特别是对于那些有良好习惯编写单元测试的程序员而言，简直是噩梦，用例也得跟着改。</p>
<p>异常设计不合理。在既往的工作经历中曾经有一次会议，就 RPC 调用中的异常设计引发了争议，一派人觉得需要有一个业务 CommonResponse，封装异常，每次调用后，优先判断调用结果是否 success，在进行业务逻辑处理；另一派人觉得这比较麻烦，由于 RPC 框架是可以封装异常调用的，所以应当直接 try catch 异常，不需要进行业务包裹。在没有明确规范时，这两种风格的代码同时存在于项目中，十分难看！</p>
<p>在千米网的三个月中，看了不少最佳实践。加上一次公司内部易永健老师的分享，涉及到了相同的话题，耳濡目染，这些曾经我发觉的痛点也逐渐有了解决之道。</p>
<ol start="3">
<li>单参数接口</li>
</ol>
<p>如果你使用过 springcloud ，可能会不适应 http 通信的限制，因为 @RequestBody 只能使用单一的参数，也就意味着，springcloud 构建的微服务架构下，接口天然是单参数的。而 RPC 方法入参的个数在语法层面是不会受到限制的，但如果强制要求入参为单参数，会解决一部分的痛点。</p>
<p><strong>使用 Specification 模式解决查询接口过多的问题</strong></p>
<pre tabindex="0"><code>
public interface StudentApi {  
Student findByName(String name);  
List&lt;Student&gt; findAllByName(String name);  
Student findByNameAndNo(String name,String no);  
Student findByIdcard(String Idcard);  
}
</code></pre><p>如上的多个查询方法目的都是同一个：根据条件查询出 Student，只不过查询条件有所差异。试想一下，Student 对象假设有 10 个属性，最坏的情况下它们的排列组合都可能作为查询条件，这便是查询接口过多的根源。</p>
<pre tabindex="0"><code>
public interface StudentApi {  
Student findBySpec(StudentSpec spec);  
List&lt;Student&gt; findListBySpec(StudentListSpec spec);  
Page&lt;Student&gt; findPageBySpec(StudentPageSpec spec);  
}
</code></pre><p>上述接口便是最通用的单参接口，三个方法几乎囊括了 99% 的查询条件。所有的查询条件都被封装在了 StudentSpec,StudentListSpec,StudentPageSpec 之中，分别满足了单对象查询，批量查询，分页查询的需求。如果你了解领域驱动设计，会发现这里借鉴了其中 Specification 模式的思想。</p>
<p><strong>单参数易于做统一管理</strong></p>
<pre tabindex="0"><code>
public interface SomeProvider {  
void opA(ARequest request);  
void opB(BRequest request);  
CommonResponse&lt;C&gt; opC(CRequest request);  
}
</code></pre><p>入参中的入参虽然形态各异，但由于是单个入参，所以可以统一继承 AbstractBaseRequest，即上述的 ARequest，BRequest，CRequest 都是 AbstractBaseRequest 的子类。在千米内部项目中，AbstractBaseRequest 定义了 traceId、clientIp、clientType、operationType 等公共入参，减少了重复命名，我们一致认为，这更加的 OO。</p>
<p>有了 AbstractBaseRequest，我们可以更加轻松地在其之上做 AOP，千米的实践中，大概做了如下的操作：</p>
<p>请求入参统一校验（request.checkParam(); param.checkParam();）</p>
<p>实体变更统一加锁，降低锁粒度</p>
<p>请求分类统一处理（if (request instanceof XxxRequest)）</p>
<p>请求报文统一记日志（log.setRequest(JsonUtil.getJsonString(request)))</p>
<p>操作成功统一发消息</p>
<p>如果不遵守单参数的约定，上述这些功能也并不是无法实现，但所需花费的精力远大于单参数，一个简单的约定带来的优势，我们认为是值得的。</p>
<p><strong>单参数入参兼容性强</strong></p>
<p>还记得前面的小节中，我提到了 SpringCloud，在 SpringCloud Feign 中，接口的入参通常会被 @RequestBody 修饰，强制做单参数的限制。千米内部使用了 Dubbo 作为 Rpc 框架，一般而言，为 Dubbo 服务设计的接口是不能直接用作 Feign 接口的（主要是因为 @RequestBody 的限制），但有了单参数的限制，便使之成为了可能。为什么我好端端的 Dubbo 接口需要兼容 Feign 接口？可能会有人发出这样的疑问，莫急，这样做的初衷当然不是为了单纯做接口兼容，而是想充分利用 HTTP 丰富的技术栈以及一些自动化工具。</p>
<p>自动生成 HTTP 接口实现（让服务端同时支持 Dubbo 和 HTTP 两种服务接口）</p>
<p>看过我之前文章的朋友应该了解过一个设计：千米内部支持的是 Dubbo 协议和 HTTP 协议族（如 JSON RPC 协议，Restful 协议），这并不意味着程序员需要写两份代码，我们可以通过 Dubbo 接口自动生成 HTTP 接口，体现了单参数设计的兼容性之强。</p>
<p>通过 Swagger UI 实现对 Dubbo 接口的可视化便捷测试</p>
<p>又是一个兼容 HTTP 技术栈带来的便利，在 Restful 接口的测试中，Swagger 一直是备受青睐的一个工具，但可惜的是其无法对 Dubbo 接口进行测试。兼容 HTTP 后，我们只需要做一些微小的工作，便可以实现 Swagger 对 Dubbo 接口的可视化测试。</p>
<p>有利于 TestNg 集成测试</p>
<p>自动生成 TestNG 集成测试代码和缺省测试用例，这使得服务端接口集成测试变得异常简单，程序员更能集中精力设计业务用例，结合缺省用例、JPA 自动建表和 PowerMock 模拟外部依赖接口实现本机环境。</p>
<img loading="lazy" decoding="async" src="https://www.bridgeli.cn/wp-content/uploads/2018/09/TestNg-1024x776.png" alt="" width="1024" height="776" class="alignnone size-medium wp-image-573" /> 
<p>这块涉及到了公司内部的代码，只做下简单介绍，我们一般通过内部项目 com.qianmi.codegenerator:api-dubbo-2-restful ，com.qianmi.codegenerator:api-request-json 生成自动化的测试用例，方便测试。而这些自动化工具中大量使用了反射，而由于单参数的设计，反射用起来比较方便。</p>
<ol start="4">
<li>接口异常设计</li>
</ol>
<p>首先肯定一点，RPC 框架是可以封装异常的，Exception 也是返回值的一部分。在 go 语言中可能更习惯于返回 err,res 的组合，但 JAVA 中我个人更偏向于 try catch 的方法捕获异常。RPC 接口设计中的异常设计也是一个注意点。</p>
<p><strong>初始方案</strong></p>
<pre tabindex="0"><code>
public interface ModuleAProvider {  
void opA(ARequest request);  
void opB(BRequest request);  
CommonResponse&lt;C&gt; opC(CRequest request);  
}
</code></pre><p>我们假设模块 A 存在上述的 ModuleAProvider 接口，ModuleAProvider 的实现中或多或少都会出现异常，例如可能存在的异常 ModuleAException，调用者实际上并不知道 ModuleAException 的存在，只有当出现异常时，才会知晓。对于 ModuleAException 这种业务异常，我们更希望调用方能够显示的处理，所以 ModuleAException 应该被设计成 Checked Excepition。</p>
<p><strong>正确的异常设计姿势</strong></p>
<pre tabindex="0"><code>
public interface ModuleAProvider {  
void opA(ARequest request) throws ModuleAException;  
void opB(BRequest request) throws ModuleAException;  
CommonResponse&lt;C&gt; opC(CRequest request) throws ModuleAException;  
}
</code></pre><p>上述接口中定义的异常实际上也是一种契约，契约的好处便是不需要叙述，调用方自然会想到要去处理 Checked Exception，否则连编译都过不了。</p>
<p><strong>调用方的处理方式</strong></p>
<p>在 ModuleB 中，应当如下处理异常：</p>
<pre tabindex="0"><code>
public class ModuleBService implements ModuleBProvider {  
@Reference  
private ModuleAProvider moduleAProvider;

@Override  
public void someOp() throws ModuleBexception {  
try {  
moduleAProvider.opA(&amp;#8230;);  
} catch (ModuleAException e) {  
throw new ModuleBException(e.getMessage());  
}  
}

@Override  
public void anotherOp() {  
try {  
moduleAProvider.opB(&amp;#8230;);  
} catch(ModuleAException e) {  
// 业务逻辑处理  
}  
}  
}
</code></pre><p>someOp 演示了一个异常流的传递，ModuleB 暴露出去的异常应当是 ModuleB 的 api 模块中异常类，虽然其依赖了 ModuleA ，但需要将异常进行转换，或者对于那些意料之中的业务异常可以像 anotherOp() 一样进行处理，不再传递。这时如果新增 ModuleC 依赖 ModuleB，那么 ModuleC 完全不需要关心 ModuleA 的异常。</p>
<p><strong>异常与熔断</strong></p>
<p>作为系统设计者，我们应该认识到一点： RPC 调用，失败是常态。通常我们需要对 RPC 接口做熔断处理，比如千米内部便集成了 Netflix 提供的熔断组件 Hystrix。Hystrix 需要知道什么样的异常需要进行熔断，什么样的异常不能够进行熔断。在没有上述的异常设计之前，回答这个问题可能还有些难度，但有了 Checked Exception 的契约，一切都变得明了清晰了。</p>
<pre tabindex="0"><code>
public class ModuleAProviderProxy {

@Reference  
private ModuleAProvider moduleAProvider;

@HystrixCommand(ignoreExceptions = {ModuleAException.class})  
public void opA(ARequest request) throws ModuleAException {  
moduleAProvider.opA(request);  
}

@HystrixCommand(ignoreExceptions = {ModuleAException.class})  
public void opB(BRequest request) throws ModuleAException {  
moduleAProvider.oBB(request);  
}

@HystrixCommand(ignoreExceptions = {ModuleAException.class})  
public CommonResponse&lt;C&gt; opC(CRequest request) throws ModuleAException {  
return moduleAProvider.opC(request);  
}

}
</code></pre><p>如服务不可用等原因引发的多次接口调用超时异常，会触发 Hystrix 的熔断；而对于业务异常，我们则认为不需要进行熔断，因为对于接口 throws 出的业务异常，我们也认为是正常响应的一部分，只不过借助于 JAVA 的异常机制来表达。实际上，和生成自动化测试类的工具一样，我们使用了另一套自动化的工具，可以由 Dubbo 接口自动生成对应的 Hystrix Proxy。我们坚定的认为开发体验和用户体验一样重要，所以公司内部会有非常多的自动化工具。</p>
<ol start="5">
<li>API 版本单独演进</li>
</ol>
<p>引用一段公司内部的真实对话：</p>
<p>A：我下载了你们的代码库怎么编译不通过啊，依赖中 xxx-api-1.1.3 版本的 jar 包找不到了，那可都是 RELEASE 版本啊。<br>
B：你不知道我们 nexus 容量有限，只能保存最新的 20 个 RELEASE 版本吗？那个 API 现在最新的版本是 1.1.31 啦。<br>
A：啊，这才几个月就几十个 RELEASE 版本啦？这接口太不稳定啦。<br>
B： 其实接口一行代码没改，我们业务分析是很牛逼的，一直很稳定。但是这个 API 是和我们项目一起打包的，我们需求更新一次，就发布一次，API 就被迫一起升级版本。发生这种事，大家都不想的。</p>
<p>在单体式架构中，版本演进的单位是整个项目。微服务解决的一个关键的痛点便是其做到了每个服务的单独演进，这大大降低了服务间的耦合。正如我文章开始时举得那个例子一样：serviceA 是一个演进的单位，serviceA-api 和 serviceA-app 这两个 Module 从属于 serviceA，这意味着 app 的一次升级，将会引发 api 的升级，因为他们是共生的！而从微服务的使用角度来看，调用者关心的是 api 的结构，而对其实现压根不在乎。所以对于 api 定义未发生变化，其 app 发生变化的那些升级，其实可以做到对调用者无感知。在实践中也是如此<br>
api 版本的演进应该是缓慢的，而 app 版本的演进应该是频繁的。<br>
所以，对于这两个演进速度不一致的模块，我们应该单独做版本管理，他们有自己的版本号。</p>
<ol start="6">
<li>问题回归</li>
</ol>
<p>查询接口过多。各种 findBy 方法，加上各自的重载，几乎占据了一个接口 80% 的代码量。这也符合一般人的开发习惯，因为页面需要各式各样的数据格式，加上查询条件差异很大，便造成了：一个查询条件，一个方法的尴尬场景。这样会导致另外一个问题，需要使用某个查询方法时，直接新增了方法，但实际上可能这个方法已经出现过了，隐藏在了令人眼花缭乱的方法中。<br>
解决方案：使用单参+Specification 模式，降低重复的查询方法，大大降低接口中的方法数量。</p>
<p>难以扩展。接口的任何改动，比如新增一个入参，都会导致调用者被迫升级，这也通常是 RPC 设计被诟病的一点，不合理的 RPC 接口设计会放大这个缺点。<br>
解决方案：单参设计其实无形中包含了所有的查询条件的排列组合，可以直接在 app 实现逻辑的新增，而不需要对 api 进行改动（如果是参数的新增则必须进行 api 的升级，参数的废弃可以用 @Deprecated 标准）。</p>
<p>升级困难。 在之前的 “初识 RPC 接口设计”一节中，版本管理的粒度是 project，而不是 module，这意味着：api 即使没有发生变化，app 版本演进，也会造成 api 的被迫升级，因为 project 是一个整体。问题又和上一条一样了，api 一旦发生变化，调用者也得被迫升级，牵一发而动全身。<br>
解决方案：以 module 为版本演进的粒度。api 和 app 单独演进，减少调用者的不必要升级次数。</p>
<p>难以测试。接口一多，职责随之变得繁杂，业务场景各异，测试用例难以维护。特别是对于那些有良好习惯编写单元测试的程序员而言，简直是噩梦，用例也得跟着改。<br>
解决方案：单参数设计+自动化测试工具，打造良好的开发体验。</p>
<p>异常设计不合理。在既往的工作经历中曾经有一次会议，就 RPC 调用中的异常设计引发了争议，一派人觉得需要有一个业务 CommonResponse，封装异常，每次调用后，优先判断调用结果是否 success，在进行业务逻辑处理；另一派人觉得这比较麻烦，由于 RPC 框架是可以封装异常调用的，所以应当直接 try catch 异常，不需要进行业务包裹。在没有明确规范时，这两种风格的代码同时存在于项目中，十分难看！<br>
解决方案：Checked Exception+正确异常处理姿势，使得代码更加优雅，降低了调用方不处理异常带来的风险。</p>
<p>原文链接：https://mp.weixin.qq.com/s/BVRJOFzehksPltoUZtBQsg</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/rpc/">Rpc</a></li>
      <li><a href="http://localhost:1313/tags/%E6%8E%A5%E5%8F%A3/">接口</a></li>
    </ul>

<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 【转载】设计 RPC 接口时，你有考虑过这些吗？ on x"
            href="https://x.com/intent/tweet/?text=%e3%80%90%e8%bd%ac%e8%bd%bd%e3%80%91%e8%ae%be%e8%ae%a1%20RPC%20%e6%8e%a5%e5%8f%a3%e6%97%b6%ef%bc%8c%e4%bd%a0%e6%9c%89%e8%80%83%e8%99%91%e8%bf%87%e8%bf%99%e4%ba%9b%e5%90%97%ef%bc%9f&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2018-09-02-%25E8%25BD%25AC%25E8%25BD%25BD%25E8%25AE%25BE%25E8%25AE%25A1-rpc-%25E6%258E%25A5%25E5%258F%25A3%25E6%2597%25B6%25E4%25BD%25A0%25E6%259C%2589%25E8%2580%2583%25E8%2599%2591%25E8%25BF%2587%25E8%25BF%2599%25E4%25BA%259B%25E5%2590%2597%2f&amp;hashtags=rpc%2c%e6%8e%a5%e5%8f%a3">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 【转载】设计 RPC 接口时，你有考虑过这些吗？ on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2018-09-02-%25E8%25BD%25AC%25E8%25BD%25BD%25E8%25AE%25BE%25E8%25AE%25A1-rpc-%25E6%258E%25A5%25E5%258F%25A3%25E6%2597%25B6%25E4%25BD%25A0%25E6%259C%2589%25E8%2580%2583%25E8%2599%2591%25E8%25BF%2587%25E8%25BF%2599%25E4%25BA%259B%25E5%2590%2597%2f&amp;title=%e3%80%90%e8%bd%ac%e8%bd%bd%e3%80%91%e8%ae%be%e8%ae%a1%20RPC%20%e6%8e%a5%e5%8f%a3%e6%97%b6%ef%bc%8c%e4%bd%a0%e6%9c%89%e8%80%83%e8%99%91%e8%bf%87%e8%bf%99%e4%ba%9b%e5%90%97%ef%bc%9f&amp;summary=%e3%80%90%e8%bd%ac%e8%bd%bd%e3%80%91%e8%ae%be%e8%ae%a1%20RPC%20%e6%8e%a5%e5%8f%a3%e6%97%b6%ef%bc%8c%e4%bd%a0%e6%9c%89%e8%80%83%e8%99%91%e8%bf%87%e8%bf%99%e4%ba%9b%e5%90%97%ef%bc%9f&amp;source=http%3a%2f%2flocalhost%3a1313%2fposts%2f2018-09-02-%25E8%25BD%25AC%25E8%25BD%25BD%25E8%25AE%25BE%25E8%25AE%25A1-rpc-%25E6%258E%25A5%25E5%258F%25A3%25E6%2597%25B6%25E4%25BD%25A0%25E6%259C%2589%25E8%2580%2583%25E8%2599%2591%25E8%25BF%2587%25E8%25BF%2599%25E4%25BA%259B%25E5%2590%2597%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 【转载】设计 RPC 接口时，你有考虑过这些吗？ on reddit"
            href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2018-09-02-%25E8%25BD%25AC%25E8%25BD%25BD%25E8%25AE%25BE%25E8%25AE%25A1-rpc-%25E6%258E%25A5%25E5%258F%25A3%25E6%2597%25B6%25E4%25BD%25A0%25E6%259C%2589%25E8%2580%2583%25E8%2599%2591%25E8%25BF%2587%25E8%25BF%2599%25E4%25BA%259B%25E5%2590%2597%2f&title=%e3%80%90%e8%bd%ac%e8%bd%bd%e3%80%91%e8%ae%be%e8%ae%a1%20RPC%20%e6%8e%a5%e5%8f%a3%e6%97%b6%ef%bc%8c%e4%bd%a0%e6%9c%89%e8%80%83%e8%99%91%e8%bf%87%e8%bf%99%e4%ba%9b%e5%90%97%ef%bc%9f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 【转载】设计 RPC 接口时，你有考虑过这些吗？ on facebook"
            href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fposts%2f2018-09-02-%25E8%25BD%25AC%25E8%25BD%25BD%25E8%25AE%25BE%25E8%25AE%25A1-rpc-%25E6%258E%25A5%25E5%258F%25A3%25E6%2597%25B6%25E4%25BD%25A0%25E6%259C%2589%25E8%2580%2583%25E8%2599%2591%25E8%25BF%2587%25E8%25BF%2599%25E4%25BA%259B%25E5%2590%2597%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 【转载】设计 RPC 接口时，你有考虑过这些吗？ on whatsapp"
            href="https://api.whatsapp.com/send?text=%e3%80%90%e8%bd%ac%e8%bd%bd%e3%80%91%e8%ae%be%e8%ae%a1%20RPC%20%e6%8e%a5%e5%8f%a3%e6%97%b6%ef%bc%8c%e4%bd%a0%e6%9c%89%e8%80%83%e8%99%91%e8%bf%87%e8%bf%99%e4%ba%9b%e5%90%97%ef%bc%9f%20-%20http%3a%2f%2flocalhost%3a1313%2fposts%2f2018-09-02-%25E8%25BD%25AC%25E8%25BD%25BD%25E8%25AE%25BE%25E8%25AE%25A1-rpc-%25E6%258E%25A5%25E5%258F%25A3%25E6%2597%25B6%25E4%25BD%25A0%25E6%259C%2589%25E8%2580%2583%25E8%2599%2591%25E8%25BF%2587%25E8%25BF%2599%25E4%25BA%259B%25E5%2590%2597%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 【转载】设计 RPC 接口时，你有考虑过这些吗？ on telegram"
            href="https://telegram.me/share/url?text=%e3%80%90%e8%bd%ac%e8%bd%bd%e3%80%91%e8%ae%be%e8%ae%a1%20RPC%20%e6%8e%a5%e5%8f%a3%e6%97%b6%ef%bc%8c%e4%bd%a0%e6%9c%89%e8%80%83%e8%99%91%e8%bf%87%e8%bf%99%e4%ba%9b%e5%90%97%ef%bc%9f&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2018-09-02-%25E8%25BD%25AC%25E8%25BD%25BD%25E8%25AE%25BE%25E8%25AE%25A1-rpc-%25E6%258E%25A5%25E5%258F%25A3%25E6%2597%25B6%25E4%25BD%25A0%25E6%259C%2589%25E8%2580%2583%25E8%2599%2591%25E8%25BF%2587%25E8%25BF%2599%25E4%25BA%259B%25E5%2590%2597%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 【转载】设计 RPC 接口时，你有考虑过这些吗？ on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=%e3%80%90%e8%bd%ac%e8%bd%bd%e3%80%91%e8%ae%be%e8%ae%a1%20RPC%20%e6%8e%a5%e5%8f%a3%e6%97%b6%ef%bc%8c%e4%bd%a0%e6%9c%89%e8%80%83%e8%99%91%e8%bf%87%e8%bf%99%e4%ba%9b%e5%90%97%ef%bc%9f&u=http%3a%2f%2flocalhost%3a1313%2fposts%2f2018-09-02-%25E8%25BD%25AC%25E8%25BD%25BD%25E8%25AE%25BE%25E8%25AE%25A1-rpc-%25E6%258E%25A5%25E5%258F%25A3%25E6%2597%25B6%25E4%25BD%25A0%25E6%259C%2589%25E8%2580%2583%25E8%2599%2591%25E8%25BF%2587%25E8%25BF%2599%25E4%25BA%259B%25E5%2590%2597%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2026 <a href="http://localhost:1313/">分享技术带来的喜悦</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu');
    if (menu) {
        
        const scrollPosition = localStorage.getItem("menu-scroll-position");
        if (scrollPosition) {
            menu.scrollLeft = parseInt(scrollPosition, 10);
        }
        
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        const html = document.querySelector("html");
        if (html.dataset.theme === "dark") {
            html.dataset.theme = 'light';
            localStorage.setItem("pref-theme", 'light');
        } else {
            html.dataset.theme = 'dark';
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
